<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日本購物清單 - 全新開始版</title>
    <style>
        :root{--p:#6366f1;--s:#10b981;--d:#ef4444;--bg:#f0f9ff;--c:white;--r:16px;--sh:0 15px 35px -5px rgba(0,0,0,0.12)}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Microsoft JhengHei','Segoe UI',sans-serif}
        body{background:linear-gradient(135deg,#f0f9ff,#e0f2fe);color:#1e293b;padding:20px;line-height:1.6;min-height:100vh}
        .container{max-width:1200px;margin:0 auto;background:var(--c);border-radius:24px;overflow:hidden;box-shadow:var(--sh)}
        header{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;padding:2.5rem 2rem;text-align:center}
        h1{font-size:2.5rem;font-weight:800;margin-bottom:0.5rem}
        .subtitle{font-size:1.2rem;opacity:0.95}

        .add-section{background:var(--c);padding:2rem;border-bottom:1px solid #e0e7ff}
        .add-form{display:flex;flex-wrap:wrap;gap:12px;align-items:end;justify-content:center;max-width:100%;margin:0 auto}
        .form-group{flex:1;min-width:180px;max-width:300px}
        .form-group.full{flex:2;min-width:250px}
        input,select,button{width:100%;padding:14px 16px;border:2px solid #e2e8f0;border-radius:12px;font-size:1rem;transition:border 0.3s}
        input:focus,select:focus{border-color:var(--p);outline:none}
        button{background:var(--p);color:white;border:none;font-weight:700;cursor:pointer;min-width:120px;font-size:1.1rem}
        button:hover{background:#4f46e5}
        .btn-success{background:#28a745}
        .btn-danger{background:#dc3545}

        .controls-bar{display:flex;justify-content:space-between;align-items:center;padding:1.5rem 2rem;background:#f8f9ff;flex-wrap:wrap;gap:1rem}
        .total-display{font-size:2rem;font-weight:900;color:var(--p);text-shadow:0 2px 4px rgba(99,102,241,0.3)}

        .lists{padding:2rem}
        .category{margin-bottom:2.5rem}
        .category h2{background:linear-gradient(135deg,var(--p),#8b5cf6);color:white;padding:1rem 1.5rem;border-radius:12px;font-size:1.4rem;margin-bottom:1rem;box-shadow:0 4px 15px rgba(99,102,241,0.3)}
        .checklist{list-style:none;background:#fafbff;border-radius:12px;overflow:hidden}
        .checklist li{display:grid;grid-template-columns:80px 2fr 1fr 1fr 1.5fr 50px 50px;gap:12px;align-items:center;padding:18px;margin:8px;background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);transition:all 0.3s ease}
        .checklist li:hover{transform:translateY(-3px);box-shadow:0 10px 25px rgba(0,0,0,0.15)}
        .item-img{width:80px;height:80px;object-fit:cover;border-radius:12px}
        .item-name{font-weight:700;font-size:1.15rem}
        .item-price{font-weight:800;color:var(--p);font-size:1.2rem}
        .delete-btn{background:none;border:none;font-size:1.6rem;cursor:pointer;color:#cbd5e1}
        .delete-btn:hover{color:var(--d)}
        .checked{opacity:0.6;text-decoration:line-through !important;color:#94a3b8 !important}
        .checked .item-price{color:#94a3b8 !important}

        footer{text-align:center;padding:3rem 2rem;color:#64748b;font-size:0.95rem;background:#f8f9ff}

        @media(max-width:768px){
            .form-group{min-width:100%;max-width:none}
            .add-form{justify-content:stretch}
            . like{grid-template-columns:70px 1fr auto auto;padding:14px}
            .item-price,.item-shop,.item-note{display:none}
            h1{font-size:2rem}
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>日本購物清單</h1>
            <p class="subtitle">每次開啟全新開始 • 匯出後也能勾選刪除線</p>
        </header>

        <div class="add-section">
            <div class="add-form">
                <div class="form-group full">
                    <input type="text" id="n" placeholder="商品名稱（必填）">
                </div>
                <div class="form-group">
                    <input type="text" id="s" placeholder="店鋪">
                </div>
                <div class="form-group">
                    <input type="number" id="p" placeholder="金額" min="0">
                </div>
                <div class="form-group">
                    <select id="c">
                        <option value="drugstore">藥妝美妝</option>
                        <option value="snacks">零食伴手禮</option>
                        <option value="goods">生活電器</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" id="t" placeholder="備註">
                </div>
                <div class="form-group">
                    <input type="file" id="i" accept="image/*">
                </div>
                <div class="form-group">
                    <button onclick="add()">新增</button>
                </div>
            </div>
        </div>

        <div class="controls-bar">
            <div>
                <button class="btn-success" onclick="exp()">匯出專業版（可勾選）</button>
                <button class="btn-danger" onclick="clr()">清除全部</button>
            </div>
            <div class="total-display" id="total">總金額：¥0</div>
        </div>

        <div class="lists" id="lists"></div>
    </div>

    <footer>
        每次開啟自動清空 • 匯出後也能打勾 • 單檔永不遺失
    </footer>

    <script>
        // === 功能1：每次開啟強制清空快取 + 全新開始 ===
        if (performance.navigation.type === 1) {
            localStorage.removeItem('japan2025-clean');
        }
        // 或者更強硬：每次載入都清空（你現在用的就是這個）
        localStorage.removeItem('japan2025-clean');
        
        const K='japan2025-clean', C={drugstore:'藥妝美妝',snacks:'零食伴手禮',goods:'生活電器',other:'其他'};
        let D = {drugstore:[],snacks:[],goods:[],other:[]}; // 每次開啟都全新！

        function $(id){return document.getElementById(id)}
        function fileToB64(file){return new Promise(r=>{let fr=new FileReader();fr.onload=()=>r(fr.result);fr.readAsDataURL(file)})}

        function render(){
            $('lists').innerHTML='';
            let total=0;
            Object.keys(D).forEach(cat=>{
                if(D[cat].length==0) return;
                let div=document.createElement('div');div.className='category';
                div.innerHTML=`<h2>${C[cat]}</h2><div class="checklist" id="${cat}"></div>`;
                $('lists').appendChild(div);
                let ul=$(cat);
                D[cat].forEach(it=>{
                    if(!it.k) total+=it.p;
                    let li=document.createElement('li');
                    li.className = it.k ? 'checked' : '';
                    li.innerHTML=`
                        <img src="${it.i||'https://via.placeholder.com/80/f0f0f0/666?text=無圖'}" class="item-img">
                        <div class="item-name">${e(it.n)}</div>
                        <div class="item-shop">${e(it.s||'-')}</div>
                        <div class="item-price">¥${it.p.toLocaleString()}</div>
                        <div class="item-note">${e(it.t||'')}</div>
                        <input type="checkbox" ${it.k?'checked':''}>
                        <button class="delete-btn" onclick="del('${cat}',${it.id})">✕</button>
                    `;
                    li.querySelector('input').onchange=e=>{
                        it.k=e.target.checked;
                        li.className = it.k ? 'checked' : '';
                        render();
                    };
                    ul.appendChild(li);
                });
            });
            $('total').textContent=`總金額：¥${total.toLocaleString()}`;
        }

        async function add(){
            let n=$('n').value.trim();if(!n)return alert('請輸入商品名稱！');
            let img='';
            if($('i').files[0]) img=await fileToB64($('i').files[0]);
            let item={id:Date.now(),n:n,s:$('s').value.trim(),p:parseInt($('p').value)||0,
                      c:$('c').value,t:$('t').value.trim(),i:img,k:false};
            D[item.c].push(item);render();
            $('n').value='';$('s').value='';$('p').value='';$('t').value='';$('i').value='';$('n').focus();
        }

        function del(cat,id){
            if(confirm('確定刪除？')){D[cat]=D[cat].filter(x=>x.id!=id);render();}
        }
        function clr(){if(confirm('全部清除？')){D={drugstore:[],snacks:[],goods:[],other:[]};render();}}
        function e(t){let d=document.createElement('div');d.textContent=t;return d.innerHTML}

        // === 功能2：匯出的 HTML 也能勾選 + 刪除線 ===
        function exp(){
            let total=0;Object.values(D).flat().forEach(x=> {!x.k && (total+=x.p)});
            let html=`<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>日本購物清單 2025</title><style>
            body{background:linear-gradient(135deg,#f0f9ff,#e0f2fe);font-family:'Microsoft JhengHei',sans-serif;padding:20px}
            .container{max-width:1000px;margin:0 auto;background:white;border-radius:20px;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,0.1);padding:30px}
            header{text-align:center;padding:40px 20px;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;border-radius:20px;margin:-30px -30px 30px -30px}
            h1{font-size:3rem;font-weight:900}h2{font-size:1.8rem;color:#6366f1;border-bottom:4px solid #6366f1;padding-bottom:10px;margin:40px 0 20px 0}
            .total{font-size:2.5rem;margin:20px 0;font-weight:900}
            li{list-style:none;display:grid;grid-template-columns:100px 2fr 1fr 1fr 1.5fr 60px;gap:20px;padding:25px;background:#f8f9ff;margin:15px 0;border-radius:18px;align-items:center;position:relative}
            img{width:100px;height:100px;object-fit:cover;border-radius:15px}
            .n{font-weight:800;font-size:1.4rem}.p{font-weight:900;color:#6366f1;font-size:1.6rem}
            input[type=checkbox]{transform:scale(1.8);cursor:pointer}
            .checked{opacity:0.6;text-decoration:line-through !important;color:#94a3b8 !important}
            .checked .p{color:#94a3b8 !important}
            @media(max-width:768px){li{grid-template-columns:100px 1fr 60px};.p,.shop,.note{display:none}}
            </style></head><body>
            <div class="container">
            <header><h1>日本購物清單 2025</h1><div class="total">總金額：¥${total.toLocaleString()}</div></header>`;
            
            Object.keys(D).forEach(cat=>{
                let list=D[cat];
                if(list.length==0) return;
                html+=`<h2>${C[cat]}</h2><div>`;
                list.forEach(it=>{
                    html+=`<div style="display:grid;grid-template-columns:100px 2fr 1fr 1fr 1.5fr 60px;gap:20px;padding:25px;background:#f8f9ff;margin:15px 0;border-radius:18px;align-items:center" class="${it.k?'checked':''}">
                        <img src="${it.i||'https://via.placeholder.com/100/eee/666?text=無圖'}">
                        <div class="n">${e(it.n)}</div>
                        <div>${e(it.s||'-')}</div>
                        <div class="p">¥${it.p.toLocaleString()}</div>
                        <div>${e(it.t||'')}</div>
                        <input type="checkbox" ${it.k?'checked':''} onchange="this.parentNode.classList.toggle('checked')">
                    </div>`;
                });
                html+=`</div>`;
            });
            html+=`<p style="text-align:center;color:#888;margin-top:60px;font-size:1.1rem">
                由 日本購物清單 全新開始版 產生 • ${new Date().toLocaleString('zh-TW')}<br>
                <small>匯出後也能勾選完成喔！</small>
            </p></div></body></html>`;
            
            let blob=new Blob([html],{type:'text/html;charset=utf-8'});
            let a=document.createElement('a');
            a.href=URL.createObjectURL(blob);
            a.download='日本購物清單_2025_可勾選版.html';
            a.click();
            alert('匯出成功！下載的檔案也能打勾+刪除線！');
        }

        render();
    </script>
</body>
</html>