/*
Shopping List React Single-file Component
Features implemented:
1. Add new list button; app starts with an empty working list (auto-clear on open).
2. Offline input page: add/edit/delete items locally (no server). All data lives in state; exported file contains data for later import.
3. Fields: name, store, amount, category, notes, image (preview). Amounts auto-summed.
4. "Export HTML" button: generates a responsive, print-friendly HTML file containing a styled list and an embedded JSON data blob for later import.
5. Professional & intuitive UI with Tailwind, image preview, drag-and-drop reorder (HTML5 drag/drop).
6. "Import Old File" accepts a previously exported HTML and restores the list for continued editing.

Usage:
- This is a single React component. Drop into a React + Tailwind project.
- It uses only built-in browser APIs so it works offline (no external libs required).
*/

import React, { useEffect, useState, useRef } from "react";

export default function ShoppingListApp() {
  const blankItem = () => ({
    id: Date.now() + Math.random().toString(36).slice(2),
    name: "",
    store: "",
    amount: "",
    category: "",
    notes: "",
    imageDataUrl: null,
  });

  // Start with an empty working list (auto-clear on open)
  const [items, setItems] = useState([]);
  const [title, setTitle] = useState("我的清單");
  const [draggingId, setDraggingId] = useState(null);
  const fileInputRef = useRef(null);

  useEffect(() => {
    // auto-clear on open: do nothing (items default empty)
  }, []);

  // Add new item
  function addItem() {
    setItems(prev => [...prev, blankItem()]);
  }

  function updateItem(id, patch) {
    setItems(prev => prev.map(it => it.id === id ? { ...it, ...patch } : it));
  }

  function deleteItem(id) {
    setItems(prev => prev.filter(it => it.id !== id));
  }

  function handleImageUpload(id, file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => updateItem(id, { imageDataUrl: e.target.result });
    reader.readAsDataURL(file);
  }

  function totalAmount() {
    return items.reduce((s, it) => {
      const n = parseFloat(String(it.amount).replace(/,/g, ""));
      return s + (isNaN(n) ? 0 : n);
    }, 0);
  }

  // Export HTML
  function exportHTML() {
    const exportData = { title, items };
    const jsonBlob = JSON.stringify(exportData);
    const html = `<!doctype html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>${escapeHtml(title)} - 匯出清單</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;padding:20px}
  .container{max-width:900px;margin:0 auto}
  .header{display:flex;justify-content:space-between;align-items:center}
  .items{margin-top:16px}
  .item{display:flex;gap:12px;padding:12px;border-bottom:1px solid #ddd;align-items:center}
  .item .meta{flex:1}
  .thumb{width:88px;height:88px;object-fit:cover;border-radius:8px}
  @media print{.no-print{display:none}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>${escapeHtml(title)}</h1>
    <div class="no-print">列印友善 - 匯出於 ${new Date().toLocaleString()}</div>
  </div>
  <div class="summary">總金額：${formatNumber(totalAmount())}</div>
  <div class="items">
    ${items.map(it => `
      <div class="item">
        <div class="meta">
          <div><strong>${escapeHtml(it.name || '（無名稱）')}</strong></div>
          <div>${escapeHtml(it.store || '')} ${it.category ? '· ' + escapeHtml(it.category) : ''}</div>
          <div>${escapeHtml(it.notes || '')}</div>
        </div>
        <div>${formatNumber(parseFloat(String(it.amount).replace(/,/g, '')) || 0)}</div>
        ${it.imageDataUrl ? `<img src="${it.imageDataUrl}" class="thumb" />` : ''}
      </div>
    `).join("")}
  </div>
</div>

<!-- Embedded data for re-import -->
<script id="export-data" type="application/json">${escapeHtml(jsonBlob)}</script>
</body>
</html>`;

    const blob = new Blob([html], { type: "text/html;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${sanitizeFileName(title || 'shopping-list')}.html`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // Import previously exported HTML file
  function importFile(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const text = e.target.result;
      // try to find the <script id="export-data"> JSON blob
      const m = text.match(/<script[^>]*id=["']export-data["'][^>]*>([\s\S]*?)<\/script>/i);
      if (m && m[1]) {
        try {
          const data = JSON.parse(m[1]);
          // basic validation
          if (Array.isArray(data.items)) {
            // ensure each item has id
            const normalized = data.items.map(it => ({ ...blankItem(), ...it }));
            setTitle(data.title || '匯入清單');
            setItems(normalized);
            alert('已匯入清單，可繼續編輯。');
            return;
          }
        } catch (err) {
          console.error(err);
        }
      }
      alert('找不到可匯入的資料，請確認您匯入的是本應用匯出的 HTML 檔案。');
    };
    reader.readAsText(file);
  }

  // Drag & drop reordering (HTML5)
  function onDragStart(e, id) {
    setDraggingId(id);
    e.dataTransfer.effectAllowed = 'move';
  }
  function onDragOver(e) { e.preventDefault(); }
  function onDrop(e, targetId) {
    e.preventDefault();
    if (!draggingId) return;
    if (draggingId === targetId) return;
    const idxFrom = items.findIndex(i => i.id === draggingId);
    const idxTo = items.findIndex(i => i.id === targetId);
    if (idxFrom < 0 || idxTo < 0) return;
    const next = [...items];
    const [moved] = next.splice(idxFrom, 1);
    next.splice(idxTo, 0, moved);
    setItems(next);
    setDraggingId(null);
  }

  return (
    <div className="p-6 max-w-4xl mx-auto">
      <header className="flex items-center justify-between mb-4">
        <h2 className="text-2xl font-semibold">購物/費用清單</h2>
        <div className="flex gap-2">
          <button className="px-3 py-1 rounded bg-indigo-600 text-white" onClick={addItem}>新增清單項目</button>
          <button className="px-3 py-1 rounded border" onClick={() => { if (confirm('確定要清空目前工作區？（此動作不會刪除已匯出的檔案）')) setItems([]); }}>清空</button>
          <input ref={fileInputRef} type="file" accept=".html" className="hidden" onChange={e => importFile(e.target.files?.[0])} />
          <button className="px-3 py-1 rounded border" onClick={() => fileInputRef.current?.click()}>匯入舊檔</button>
          <button className="px-3 py-1 rounded bg-green-600 text-white" onClick={exportHTML}>匯出 HTML</button>
        </div>
      </header>

      <div className="mb-4 flex gap-3 items-center">
        <label className="text-sm">檔名 / 標題：</label>
        <input value={title} onChange={e => setTitle(e.target.value)} className="border p-1 rounded flex-1" />
        <div className="text-sm">總金額：<strong>{formatNumber(totalAmount())}</strong></div>
      </div>

      <div className="space-y-3">
        {items.length === 0 && (
          <div className="p-6 border-dashed border rounded text-center text-gray-500">目前工作區為空。按「新增清單項目」開始。</div>
        )}

        {items.map((it, idx) => (
          <div key={it.id}
            draggable
            onDragStart={e => onDragStart(e, it.id)}
            onDragOver={onDragOver}
            onDrop={e => onDrop(e, it.id)}
            className="p-3 border rounded flex gap-3 items-start bg-white shadow-sm">

            <div className="w-28 h-20 bg-gray-50 rounded overflow-hidden flex-shrink-0 flex items-center justify-center">
              {it.imageDataUrl ? (
                <img src={it.imageDataUrl} alt="thumb" className="object-cover w-full h-full" />
              ) : (
                <div className="text-xs text-gray-400">無圖片</div>
              )}
            </div>

            <div className="flex-1 grid grid-cols-2 gap-2">
              <div>
                <label className="text-xs text-gray-600">商品名稱</label>
                <input value={it.name} onChange={e => updateItem(it.id, { name: e.target.value })} className="w-full border rounded p-1" />
              </div>
              <div>
                <label className="text-xs text-gray-600">店鋪</label>
                <input value={it.store} onChange={e => updateItem(it.id, { store: e.target.value })} className="w-full border rounded p-1" />
              </div>

              <div>
                <label className="text-xs text-gray-600">金額</label>
                <input value={it.amount} onChange={e => updateItem(it.id, { amount: e.target.value })} placeholder="0" className="w-full border rounded p-1" />
              </div>
              <div>
                <label className="text-xs text-gray-600">類別</label>
                <input value={it.category} onChange={e => updateItem(it.id, { category: e.target.value })} className="w-full border rounded p-1" />
              </div>

              <div className="col-span-2">
                <label className="text-xs text-gray-600">備註</label>
                <input value={it.notes} onChange={e => updateItem(it.id, { notes: e.target.value })} className="w-full border rounded p-1" />
              </div>

              <div className="col-span-2 flex items-center gap-2 mt-1">
                <label className="text-xs text-gray-600">圖片</label>
                <input type="file" accept="image/*" onChange={e => handleImageUpload(it.id, e.target.files?.[0])} />
                <button className="ml-auto text-sm text-red-600" onClick={() => updateItem(it.id, { imageDataUrl: null })}>移除圖片</button>
                <button className="ml-2 text-sm text-gray-600" onClick={() => deleteItem(it.id)}>刪除</button>
              </div>

            </div>
          </div>
        ))}
      </div>

      <footer className="mt-6 text-sm text-gray-500">提示：匯出後可保留檔案並用「匯入舊檔」繼續編輯。列印時將使用匯出的樣式（響應式且列印友善）。拖曳項目以重新排序。</footer>
    </div>
  );
}

// --- Helpers ---
function escapeHtml(s) {
  if (s == null) return '';
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}
function sanitizeFileName(s) {
  return (s || 'export').replace(/[^a-z0-9\-_.\u4e00-\u9fff]/gi, '_').slice(0, 120);
}
function formatNumber(n) {
  if (n == null) return '0';
  const num = Number(n) || 0;
  return num.toLocaleString();
}
