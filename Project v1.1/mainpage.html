/*
Shopping List Standalone HTML Version with localStorage autosave.
Offline, editable single-page app.
Features:
1. Add/edit/delete shopping list items with images.
2. Auto-save to localStorage and auto-load on reopen.
3. Export as a print-friendly, responsive HTML with embedded data.
4. Import from a previously exported HTML file.
5. Works fully offline (no build tools, just open the HTML file in browser).
*/

<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>購物清單</title>
<style>
body { font-family: system-ui, sans-serif; margin: 20px; background: #f8fafc; }
.container { max-width: 900px; margin: auto; background: #fff; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
button { cursor: pointer; }
input, textarea { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
.item { border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-top: 10px; background: #fff; display: flex; gap: 10px; align-items: flex-start; }
.thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; background: #f3f3f3; display:flex; align-items:center; justify-content:center; color:#aaa; }
.header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; }
.actions button { margin-right: 6px; }
@media print { .no-print { display: none; } }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h2>購物/費用清單</h2>
    <div class="actions no-print">
      <button id="addBtn">新增項目</button>
      <button id="clearBtn">清空</button>
      <button id="importBtn">匯入舊檔</button>
      <button id="exportBtn">匯出 HTML</button>
      <input id="fileInput" type="file" accept=".html" style="display:none" />
    </div>
  </div>

  <div class="no-print" style="margin-top:10px;display:flex;gap:10px;align-items:center">
    <label>清單標題：</label>
    <input id="titleInput" placeholder="我的清單" />
    <span>總金額：<strong id="total"></strong></span>
  </div>

  <div id="list"></div>

  <p class="no-print" style="margin-top:20px;color:#666;font-size:13px">提示：資料自動儲存於瀏覽器，重新開啟仍可繼續編輯。可使用「匯出 HTML」保存離線檔案或列印。</p>
</div>

<script>
const listEl = document.getElementById('list');
const addBtn = document.getElementById('addBtn');
const clearBtn = document.getElementById('clearBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const fileInput = document.getElementById('fileInput');
const titleInput = document.getElementById('titleInput');
const totalEl = document.getElementById('total');

let items = [];
const LS_KEY = 'shopping-list-data-v1';

// Load from localStorage
window.addEventListener('load', () => {
  const saved = localStorage.getItem(LS_KEY);
  if (saved) {
    try {
      const data = JSON.parse(saved);
      titleInput.value = data.title || '我的清單';
      items = data.items || [];
    } catch {}
  }
  render();
});

// Auto-save on change
titleInput.addEventListener('input', save);

function save() {
  localStorage.setItem(LS_KEY, JSON.stringify({ title: titleInput.value, items }));
  updateTotal();
}

function addItem() {
  items.push({ id: Date.now(), name:'', store:'', amount:'', category:'', notes:'', image:null });
  render(); save();
}
function deleteItem(id) {
  items = items.filter(it=>it.id!==id);
  render(); save();
}
function updateItem(id, field, value){
  const it = items.find(x=>x.id===id);
  if(it){ it[field]=value; save(); }
}
function handleImage(id, file){
  const reader = new FileReader();
  reader.onload = e=>{ updateItem(id,'image',e.target.result); render(); };
  reader.readAsDataURL(file);
}

function clearAll(){
  if(confirm('確定清空所有資料？')){
    items=[]; localStorage.removeItem(LS_KEY); render();
  }
}

function updateTotal(){
  const sum = items.reduce((a,b)=>a+(parseFloat(b.amount)||0),0);
  totalEl.textContent = sum.toLocaleString();
}

function render(){
  listEl.innerHTML='';
  items.forEach(it=>{
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML=`
      <div class='thumb'>${it.image?`<img src='${it.image}' class='thumb'>`:'無圖片'}</div>
      <div style='flex:1;display:grid;grid-template-columns:1fr 1fr;gap:4px;'>
        <label>商品名稱<input value="${it.name}" data-field="name"></label>
        <label>店鋪<input value="${it.store}" data-field="store"></label>
        <label>金額<input value="${it.amount}" data-field="amount"></label>
        <label>類別<input value="${it.category}" data-field="category"></label>
        <label class='col-span-2'>備註<input value="${it.notes}" data-field="notes"></label>
        <div class='col-span-2 no-print' style='display:flex;gap:6px;align-items:center;'>
          <input type='file' accept='image/*' data-field='imageFile' style='flex:1;'>
          <button data-action='removeImg'>移除圖片</button>
          <button data-action='del'>刪除</button>
        </div>
      </div>`;

    div.querySelectorAll('input[data-field]').forEach(inp=>{
      inp.addEventListener('input',e=>{
        if(e.target.dataset.field==='imageFile' && e.target.files[0]) handleImage(it.id,e.target.files[0]);
        else if(e.target.dataset.field!=='imageFile') updateItem(it.id,e.target.dataset.field,e.target.value);
      });
    });
    div.querySelector('[data-action="removeImg"]').onclick=()=>{updateItem(it.id,'image',null); render();};
    div.querySelector('[data-action="del"]').onclick=()=>deleteItem(it.id);
    listEl.appendChild(div);
  });
  updateTotal();
}

function exportHTML(){
  const data = { title:titleInput.value, items };
  const json = JSON.stringify(data);
  const html = `<!doctype html><html><head><meta charset='utf-8'><title>${titleInput.value}</title></head><body>${document.querySelector('.container').outerHTML}<script id='export-data' type='application/json'>${json}</script></body></html>`;
  const blob=new Blob([html],{type:'text/html'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=(titleInput.value||'shopping-list')+'.html';a.click();URL.revokeObjectURL(url);
}

function importFile(f){
  const reader=new FileReader();
  reader.onload=e=>{
    const text=e.target.result;
    const m=text.match(/<script[^>]*id=["']export-data["'][^>]*>([\s\S]*?)<\/script>/i);
    if(m){
      try{
        const data=JSON.parse(m[1]);
        items=data.items||[]; titleInput.value=data.title||'匯入清單'; save(); render(); alert('已匯入資料。');
      }catch{alert('匯入失敗');}
    }
  };
  reader.readAsText(f);
}

addBtn.onclick=addItem;
clearBtn.onclick=clearAll;
exportBtn.onclick=exportHTML;
importBtn.onclick=()=>fileInput.click();
fileInput.onchange=e=>{ if(e.target.files[0]) importFile(e.target.files[0]); };
</script>
</body>
</html>